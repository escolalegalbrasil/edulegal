<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EduLegal - Chat</title>
<link rel="stylesheet" href="style.css">
</head>

<body>

<h1>Bem-vindo ao EduLegal ðŸš€</h1>

<div style="max-width:700px; display:flex; flex-direction:column; gap:10px;">
  <label><b>Escolha a mentoria:</b></label>
  <select id="trailSelect" style="max-width:520px;"></select>
  <button id="openTrailBtn" style="max-width:220px;">Abrir mentoria</button>
  <p id="trailStatus" style="font-size:12px; opacity:0.8;"></p>
</div>

<div id="studentInfo" style="margin-top:14px;"></div>

<!-- âœ… NOVO: Progresso Quest/Desafio -->
<div id="progressInfo" style="margin-top:10px; max-width:520px; padding:10px; border:1px dashed #ddd;">
  <b>Progresso:</b>
  <span id="questLabel">Quest 1</span> Â·
  <span id="stepLabel">Desafio 1</span>
</div>

<div id="chatBox" style="margin-top:16px; padding:12px; border:1px solid #ddd; max-width:520px;">
  <h3>Chat</h3>
  <div id="messages" style="display:flex; flex-direction:column; gap:8px; margin:10px 0;"></div>

  <textarea id="chatInput" rows="3" style="width:100%; box-sizing:border-box;" placeholder="Escreva aqui..."></textarea>

  <input type="file" id="fileInput" accept="image/*" style="margin-top:8px;" />
  <button id="uploadBtn" style="margin-top:8px;">Enviar print</button>

  <button id="sendBtn" style="margin-top:8px;">Enviar</button>

  <p id="chatStatus" style="margin-top:8px; font-size:12px; opacity:0.8;"></p>
</div>

<button onclick="logout()">Sair</button>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
const supabaseUrl = "https://xhasvagsodoctsqbfwkw.supabase.co";
const supabaseKey = "sb_publishable_xkkU9fI3Gv9dpEf7kadVBw_9GrcLZzr";
window.supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey);
</script>

<script>
(async function init() {

  const { data: sessionData } = await window.supabaseClient.auth.getSession();
  const session = sessionData?.session;

  if (!session) {
    window.location.href = "index.html";
    return;
  }

  // UI refs
  const trailSelect = document.getElementById("trailSelect");
  const openTrailBtn = document.getElementById("openTrailBtn");
  const trailStatus = document.getElementById("trailStatus");

  const studentInfoEl = document.getElementById("studentInfo");
  const messagesEl = document.getElementById("messages");
  const inputEl = document.getElementById("chatInput");
  const sendBtn = document.getElementById("sendBtn");
  const uploadBtn = document.getElementById("uploadBtn");
  const fileInput = document.getElementById("fileInput");
  const chatStatus = document.getElementById("chatStatus");

  // âœ… NOVO: labels progresso
  const questLabel = document.getElementById("questLabel");
  const stepLabel = document.getElementById("stepLabel");

  // Estado atual
  let currentTrail = null;

 function renderMessages(rows) {
  messagesEl.innerHTML = "";

  for (const m of rows) {
    const bubble = document.createElement("div");
    bubble.style.padding = "8px";
    bubble.style.borderRadius = "8px";
    bubble.style.border = m.role === "student" ? "1px solid #cfc" : "1px solid #ccf";
    bubble.style.whiteSpace = "pre-wrap";

    const content = m.content || "";
    const urlMatch = content.match(/https?:\/\/[^\s]+/);

    if (urlMatch && urlMatch[0].includes("/storage/v1/object/sign/evidence/")) {
      const img = document.createElement("img");
      img.src = urlMatch[0];
      img.style.maxWidth = "100%";
      img.style.marginTop = "6px";
      img.style.borderRadius = "6px";

      bubble.innerHTML = `<b>${m.role === "student" ? "VocÃª" : "IA"}:</b><br>${content.replace(urlMatch[0], "")}`;
      bubble.appendChild(img);
    } else {
      bubble.innerHTML = `<b>${m.role === "student" ? "VocÃª" : "IA"}:</b> ${content}`;
    }

    messagesEl.appendChild(bubble);
  }

  messagesEl.scrollTop = messagesEl.scrollHeight;
   
}

async function loadMessages() {
  if (!currentTrail) return;

  const { data: rows } = await window.supabaseClient
    .from("messages")
    .select("role,content,created_at")
    .eq("trail_id", currentTrail.id)
    .order("created_at", { ascending: true });

  const safeRows = rows || [];
  renderMessages(safeRows);

  // SÃ³ â€œdesceâ€ se jÃ¡ existe conversa
 if (safeRows.length > 0) {
  setTimeout(() => {
    // 1) garante que o chat estÃ¡ visÃ­vel
    document.getElementById("chatBox").scrollIntoView({ behavior: "smooth", block: "end" });

    // 2) rola para a Ãºltima mensagem (janela inteira)
    const last = messagesEl.lastElementChild;
    if (last) last.scrollIntoView({ behavior: "smooth", block: "end" });
  }, 150);
}
}

  function renderTrailInfo(trailRow) {
    const content = trailRow.content || {};
    const quests = Array.isArray(content.quests) ? content.quests : [];

    // âœ… usa quest/step atuais do banco
    const currentQuestNum = trailRow.current_quest ?? 1;
    const currentStepNum = trailRow.current_step ?? 1;

    const quest = quests[currentQuestNum - 1] || null;

    // compatibilidade: se nÃ£o houver steps[], usa campos antigos da quest
    const steps = Array.isArray(quest?.steps) ? quest.steps : null;
    const step = steps ? (steps[currentStepNum - 1] || steps[steps.length - 1]) : null;

    let html = `<h2>${trailRow.title || "Mentoria"}</h2>`;

    if (quest) {
      const objective = (step?.objective) || quest.goal || quest.micro_objective || "";
      const evidence = (step?.evidence_required) || quest.evidence || "";
      const cognitive = (step?.cognitive_check) || "";

      html += `
        <h3>Quest Atual</h3>
        <p><b>Quest:</b> ${currentQuestNum}</p>
        <p><b>Desafio:</b> ${currentStepNum}</p>
        <p><b>Objetivo:</b> ${objective}</p>
        ${evidence ? `<p><b>EvidÃªncia esperada:</b> ${evidence}</p>` : ""}
        ${cognitive ? `<p><b>Checagem:</b> ${cognitive}</p>` : ""}
      `;
    } else {
      html += `<p>(Sem quests encontradas no conteÃºdo)</p>`;
    }

    studentInfoEl.innerHTML = html;
  }

  async function openTrail(trailId) {
    trailStatus.textContent = "Carregando mentoria...";
    chatStatus.textContent = "";

    const { data: trailRow, error } = await window.supabaseClient
      .from("trails")
      .select("id,title,content,created_at,current_quest,current_step")
      .eq("id", trailId)
      .single();

    if (error || !trailRow) {
      trailStatus.textContent = "Erro ao carregar mentoria.";
      return;
    }

    currentTrail = trailRow;
    renderTrailInfo(trailRow);

    // âœ… atualiza labels de progresso
    questLabel.textContent = `Quest ${trailRow.current_quest ?? 1}`;
    stepLabel.textContent = `Desafio ${trailRow.current_step ?? 1}`;

    await loadMessages();
    trailStatus.textContent = `Aberta: ${trailRow.title}`;
  }

  async function loadTrailsList() {
    trailStatus.textContent = "Carregando lista de mentorias...";

    const { data: rows, error } = await window.supabaseClient
      .from("trails")
      .select("id,title,created_at")
      .order("created_at", { ascending: false })
      .limit(50);

    if (error) {
      trailStatus.textContent = "Erro ao carregar mentorias.";
      return;
    }

    trailSelect.innerHTML = "";
    (rows || []).forEach((t) => {
      const opt = document.createElement("option");
      const dateTxt = t.created_at ? new Date(t.created_at).toLocaleString() : "";
      opt.value = t.id;
      opt.textContent = `${t.title || "Mentoria"}${dateTxt ? " â€” " + dateTxt : ""}`;
      trailSelect.appendChild(opt);
    });

    if (!rows || rows.length === 0) {
      trailStatus.textContent = "Nenhuma mentoria encontrada.";
      return;
    }

    // abre automaticamente a mais recente
    await openTrail(rows[0].id);
  }

  async function sendMessage(text) {
    if (!currentTrail) return;
    if (!text) return;

    sendBtn.disabled = true;
    chatStatus.textContent = "Enviando...";

    const { error } = await window.supabaseClient.functions.invoke("edulegal-cha", {
      body: { trail_id: currentTrail.id, message: text }
    });

    sendBtn.disabled = false;
    chatStatus.textContent = "";

    if (error) {
      chatStatus.textContent = "Erro ao enviar mensagem.";
      return;
    }

    inputEl.value = "";

    // âœ… NOVO: Recarrega trail para atualizar Quest/Desafio no topo
    const { data: updatedTrail } = await window.supabaseClient
      .from("trails")
      .select("id,title,content,created_at,current_quest,current_step")
      .eq("id", currentTrail.id)
      .single();

    if (updatedTrail) {
      currentTrail = updatedTrail;
      renderTrailInfo(updatedTrail);
      questLabel.textContent = `Quest ${updatedTrail.current_quest ?? 1}`;
      stepLabel.textContent = `Desafio ${updatedTrail.current_step ?? 1}`;
    }

    await loadMessages();
  }

  sendBtn.addEventListener("click", () => {
    sendMessage(inputEl.value.trim());
  });

  inputEl.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      sendMessage(inputEl.value.trim());
    }
  });

  uploadBtn.addEventListener("click", async () => {
    if (!currentTrail) return;

    const file = fileInput.files[0];
    if (!file) return;

    uploadBtn.disabled = true;
    chatStatus.textContent = "Enviando print...";

    const userId = session.user.id;
    const filePath = `${userId}/${currentTrail.id}/${Date.now()}_${file.name}`;

    const { error: uploadError } = await window.supabaseClient.storage
      .from("evidence")
      .upload(filePath, file);

    if (uploadError) {
      chatStatus.textContent = "Erro no upload.";
      uploadBtn.disabled = false;
      return;
    }

    const { data } = await window.supabaseClient.storage
      .from("evidence")
      .createSignedUrl(filePath, 3600);

    const imageUrl = data.signedUrl;

    await sendMessage(`EVIDÃŠNCIA_PRINT (analisar imagem): ${imageUrl}`);

    fileInput.value = "";
    uploadBtn.disabled = false;
    chatStatus.textContent = "";
  });

  openTrailBtn.addEventListener("click", async () => {
    const id = trailSelect.value;
    if (!id) return;
    await openTrail(id);
  });

  // init
  await loadTrailsList();

})();

async function logout() {
  await window.supabaseClient.auth.signOut();
  window.location.href = "index.html";
}
</script>

</body>
</html>
