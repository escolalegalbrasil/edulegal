<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EduLegal - Chat</title>
<link rel="stylesheet" href="style.css">
</head>

<body>

<h1>Bem-vindo ao EduLegal ðŸš€</h1>

<div id="studentInfo"></div>
  

<div id="chatBox" style="margin-top:16px; padding:12px; border:1px solid #ddd; max-width:520px;">
  <h3>Chat</h3>
  <div id="messages" style="display:flex; flex-direction:column; gap:8px; margin:10px 0;"></div>

  <textarea id="chatInput" rows="3" style="width:100%; box-sizing:border-box;" placeholder="Escreva aqui..."></textarea>
  <button id="sendBtn" style="margin-top:8px;">Enviar</button>

  <p id="chatStatus" style="margin-top:8px; font-size:12px; opacity:0.8;"></p>
</div>
  

<button onclick="logout()">Sair</button>

<!-- 1ï¸âƒ£ Carrega Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<!-- 2ï¸âƒ£ Cria o cliente -->
<script>
  const supabaseUrl = "https://xhasvagsodoctsqbfwkw.supabase.co";
  const supabaseKey = "sb_publishable_xkkU9fI3Gv9dpEf7kadVBw_9GrcLZzr";
  window.supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey);
</script>

<!-- 3ï¸âƒ£ Seu cÃ³digo da pÃ¡gina -->
<script>
(async function init() {
  // 1) Checa sessÃ£o
  const { data: sessionData, error: sessionErr } = await window.supabaseClient.auth.getSession();
  const session = sessionData?.session;

  if (sessionErr || !session) {
    window.location.href = "index.html";
    return;
  }

  // 2) Busca trails do aluno logado
  const { data: trails, error } = await window.supabaseClient
    .from("trails")
    .select("id,title,content,created_at")
    .order("created_at", { ascending: false })
    .limit(1);

  if (error) {
    document.getElementById("studentInfo").innerHTML = `<p>Erro ao carregar mentoria: ${error.message}</p>`;
    return;
  }

  if (!trails || trails.length === 0) {
    document.getElementById("studentInfo").innerHTML = "<p>Nenhuma mentoria encontrada ainda.</p>";
    return;
  }

  const trail = trails[0];
  const content = trail.content || {};
  const quests = Array.isArray(content.quests) ? content.quests : [];

  // 3) Render mÃ­nimo (tÃ­tulo + primeira quest)
  let html = `<h2>${trail.title || "Mentoria"}</h2>`;

  if (quests.length === 0) {
    html += `<pre style="white-space:pre-wrap">${JSON.stringify(content, null, 2)}</pre>`;
  } else {
    const q1 = quests[0];
    html += `
      <h3>Quest 1</h3>
      <p><b>Objetivo:</b> ${q1.goal || q1.micro_objective || "(sem objetivo)"}</p>
      <p><b>Pergunta inicial:</b> ${q1.question || q1.initial_question || "(sem pergunta)"}</p>
      <p><b>Mini-desafio:</b> ${(q1.challenge || q1.mini_challenge?.instruction || "(sem desafio)")}</p>
    `;
  }

  document.getElementById("studentInfo").innerHTML = html;
})();

async function logout() {
  localStorage.removeItem("edulegal_student");
  localStorage.removeItem("edulegal_auth_uid");
  await window.supabaseClient.auth.signOut();
  window.location.href = "index.html";
}
</script>

</body>
</html>
