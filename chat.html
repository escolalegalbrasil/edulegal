<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EduLegal - Chat</title>
<link rel="stylesheet" href="style.css">

<style>
  /* ===== Chat page (não altera seu style.css) ===== */
  body {
    background: #201b2c;
    color: #f0ffffde;
  }

  /* Container grande e centralizado (alvo 1920 x 990) */
  .chat-shell {
    width: min(1920px, calc(100vw - 48px));
    height: min(990px, calc(100vh - 48px));
    margin: 24px auto;
    background: #2f2841;
    border-radius: 20px;
    box-shadow: 0px 10px 40px #00000056;
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }

  /* Cabeçalho fixo */
  .chat-header {
    position: sticky;
    top: 0;
    z-index: 10;
    padding: 18px 20px 14px;
    background: #2f2841;
    border-bottom: 1px solid #00000056;
  }

  .chat-header .mentoria-title {
    font-size: 22px;
    font-weight: 800;
    color: #00ff88;
    margin: 0 0 6px 0;
    letter-spacing: 0.3px;
  }

  .chat-header .quest-line {
    font-size: 18px;
    font-weight: 700;
    margin: 0 0 4px 0;
    color: #77ffc0;
  }

  .chat-header .step-line {
    font-size: 16px;
    margin: 0;
    color: #f0ffffde;
    opacity: 0.95;
  }

  /* Área superior (seletor) */
  .chat-topbar {
    display: flex;
    gap: 10px;
    align-items: center;
    padding: 14px 20px;
    border-bottom: 1px solid #00000056;
    background: #2f2841;
  }

  .chat-topbar label {
    font-weight: 700;
    color: #f0ffffde;
    margin-right: 8px;
  }

  .chat-topbar select {
    width: min(680px, 100%);
    border: none;
    border-radius: 10px;
    padding: 12px 14px;
    background: #514869;
    color: #f0ffffde;
    font-size: 14pt;
    box-shadow: 0px 10px 40px #00000056;
    outline: none;
  }

  .btn {
    border: none;
    border-radius: 10px;
    padding: 12px 14px;
    font-weight: 800;
    letter-spacing: 1px;
    cursor: pointer;
    background: #00ff88;
    color: #2b134b;
    box-shadow: 0px 10px 40px -12px #00ff8052;
    white-space: nowrap;
  }

  .btn.secondary {
    background: #514869;
    color: #f0ffffde;
    box-shadow: 0px 10px 40px #00000056;
    font-weight: 700;
    letter-spacing: 0.5px;
  }

  .status {
    font-size: 12pt;
    color: #f0ffff94;
    margin-left: auto;
  }

  /* Conteúdo principal: mensagens + composer */
  .chat-main {
    flex: 1;
    display: flex;
    flex-direction: column;
    min-height: 0; /* importante para scroll */
  }

  .messages {
    flex: 1;
    overflow: auto;
    padding: 16px 20px;
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .bubble {
    padding: 12px 12px;
    border-radius: 12px;
    background: rgba(81, 72, 105, 0.35);
    border: 1px solid #00000056;
    font-size: 15.5pt;
    line-height: 1.35;
    white-space: pre-wrap;
  }

  .bubble.student {
    border-color: rgba(0, 255, 136, 0.35);
  }

  .bubble.assistant {
    border-color: rgba(119, 255, 192, 0.25);
  }

  .bubble b {
    color: #77ffc0;
  }

  .composer {
    padding: 14px 20px 18px;
    border-top: 1px solid #00000056;
    background: #2f2841;
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .composer textarea {
    width: 100%;
    border: none;
    border-radius: 12px;
    padding: 14px;
    background: #514869;
    color: #f0ffffde;
    font-size: 15pt;
    box-shadow: 0px 10px 40px #00000056;
    outline: none;
    resize: vertical;
    min-height: 70px;
  }

  .composer-row {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    align-items: center;
  }

  .composer input[type="file"] {
    color: #f0ffff94;
  }

  .footer-row {
    display: flex;
    gap: 10px;
    align-items: center;
    justify-content: space-between;
  }

  .logout {
    margin: 0;
  }

  /* mobile/pequenas telas */
  @media (max-width: 900px) {
    .chat-shell {
      width: calc(100vw - 18px);
      height: calc(100vh - 18px);
      margin: 9px auto;
      border-radius: 14px;
    }
    .chat-topbar {
      flex-direction: column;
      align-items: stretch;
    }
    .status { margin-left: 0; }
  }
</style>
</head>

<body>

<div class="chat-shell">

  <!-- Topbar de seleção -->
  <div class="chat-topbar">
    <div style="display:flex; gap:10px; align-items:center; width:100%; flex-wrap:wrap;">
      <label><b>Mentoria:</b></label>
      <select id="trailSelect"></select>
      <button id="openTrailBtn" class="btn">Abrir</button>
      <p id="trailStatus" class="status"></p>
    </div>
  </div>

  <!-- Cabeçalho fixo -->
  <div class="chat-header">
    <p id="mentoriaTitle" class="mentoria-title">Mentoria</p>
    <p id="questLine" class="quest-line">Quest 1 — …</p>
    <p id="stepLine" class="step-line">Desafio 1/1 — …</p>
  </div>

  <div class="chat-main">
    <div id="messages" class="messages"></div>

    <div class="composer">
      <textarea id="chatInput" rows="3" placeholder="Escreva aqui..."></textarea>

      <div class="composer-row">
        <input type="file" id="fileInput" accept="image/*" />
        <button id="uploadBtn" class="btn secondary">Enviar print</button>
        <button id="sendBtn" class="btn">Enviar</button>
        <span id="chatStatus" class="status"></span>
      </div>

      <div class="footer-row">
        <span class="hint">Dica: Shift+Enter quebra linha.</span>
        <button class="btn secondary logout" onclick="logout()">Sair</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
const supabaseUrl = "https://xhasvagsodoctsqbfwkw.supabase.co";
const supabaseKey = "sb_publishable_xkkU9fI3Gv9dpEf7kadVBw_9GrcLZzr";
window.supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey);
</script>

<script>
(async function init() {
  const { data: sessionData } = await window.supabaseClient.auth.getSession();
  const session = sessionData?.session;

  if (!session) {
    window.location.href = "index.html";
    return;
  }

  // UI refs
  const trailSelect = document.getElementById("trailSelect");
  const openTrailBtn = document.getElementById("openTrailBtn");
  const trailStatus = document.getElementById("trailStatus");

  const messagesEl = document.getElementById("messages");
  const inputEl = document.getElementById("chatInput");
  const sendBtn = document.getElementById("sendBtn");
  const uploadBtn = document.getElementById("uploadBtn");
  const fileInput = document.getElementById("fileInput");
  const chatStatus = document.getElementById("chatStatus");

  // Header refs
  const mentoriaTitleEl = document.getElementById("mentoriaTitle");
  const questLineEl = document.getElementById("questLine");
  const stepLineEl = document.getElementById("stepLine");

  let currentTrail = null;

  function getQuestAndStepTitles(trailRow) {
    const content = trailRow.content || {};
    const quests = Array.isArray(content.quests) ? content.quests : [];

    const qNum = trailRow.current_quest ?? 1;
    const sNum = trailRow.current_step ?? 1;

    const quest = quests[qNum - 1] || null;

    // steps podem existir ou não
    const steps = Array.isArray(quest?.steps) ? quest.steps : null;
    const totalSteps = steps ? steps.length : 1;
    const step = steps ? (steps[sNum - 1] || steps[steps.length - 1]) : null;

    const questTitle = (quest?.title) ? quest.title : "Sem título";
    const stepTitle = (step?.title) ? step.title : "Sem título";

    return { qNum, sNum, totalSteps, questTitle, stepTitle };
  }

  function renderHeader(trailRow) {
    const { qNum, sNum, totalSteps, questTitle, stepTitle } = getQuestAndStepTitles(trailRow);

    mentoriaTitleEl.textContent = trailRow.title || "Mentoria";
    questLineEl.textContent = `Quest ${qNum} — ${questTitle}`;
    stepLineEl.textContent = `Desafio ${sNum}/${totalSteps} — ${stepTitle}`;
  }

  function renderMessages(rows) {
    messagesEl.innerHTML = "";

    for (const m of rows) {
      const bubble = document.createElement("div");
      bubble.className = `bubble ${m.role === "student" ? "student" : "assistant"}`;

      const content = m.content || "";
      const urlMatch = content.match(/https?:\/\/[^\s]+/);

      if (urlMatch && urlMatch[0].includes("/storage/v1/object/sign/evidence/")) {
        const img = document.createElement("img");
        img.src = urlMatch[0];
        img.style.maxWidth = "100%";
        img.style.marginTop = "10px";
        img.style.borderRadius = "10px";

        bubble.innerHTML = `<b>${m.role === "student" ? "Você" : "IA"}:</b><br>${content.replace(urlMatch[0], "")}`;
        bubble.appendChild(img);
      } else {
        bubble.innerHTML = `<b>${m.role === "student" ? "Você" : "IA"}:</b> ${content}`;
      }

      messagesEl.appendChild(bubble);
    }

    // scroll para baixo
    messagesEl.scrollTop = messagesEl.scrollHeight;
  }

  async function loadMessages() {
    if (!currentTrail) return;

    const { data: rows } = await window.supabaseClient
      .from("messages")
      .select("role,content,created_at")
      .eq("trail_id", currentTrail.id)
      .order("created_at", { ascending: true });

    renderMessages(rows || []);
  }

  async function openTrail(trailId) {
    trailStatus.textContent = "Carregando mentoria...";
    chatStatus.textContent = "";

    const { data: trailRow, error } = await window.supabaseClient
      .from("trails")
      .select("id,title,content,created_at,current_quest,current_step")
      .eq("id", trailId)
      .single();

    if (error || !trailRow) {
      trailStatus.textContent = "Erro ao carregar mentoria.";
      return;
    }

    currentTrail = trailRow;
    renderHeader(trailRow);
    await loadMessages();
    trailStatus.textContent = `Aberta: ${trailRow.title}`;
  }

  async function loadTrailsList() {
    trailStatus.textContent = "Carregando lista de mentorias...";

    const { data: rows, error } = await window.supabaseClient
      .from("trails")
      .select("id,title,created_at")
      .order("created_at", { ascending: false })
      .limit(50);

    if (error) {
      trailStatus.textContent = "Erro ao carregar mentorias.";
      return;
    }

    trailSelect.innerHTML = "";
    (rows || []).forEach((t) => {
      const opt = document.createElement("option");
      const dateTxt = t.created_at ? new Date(t.created_at).toLocaleString() : "";
      opt.value = t.id;
      opt.textContent = `${t.title || "Mentoria"}${dateTxt ? " — " + dateTxt : ""}`;
      trailSelect.appendChild(opt);
    });

    if (!rows || rows.length === 0) {
      trailStatus.textContent = "Nenhuma mentoria encontrada.";
      return;
    }

    await openTrail(rows[0].id);
  }

  async function refreshTrailState() {
    if (!currentTrail) return;

    const { data: updatedTrail } = await window.supabaseClient
      .from("trails")
      .select("id,title,content,created_at,current_quest,current_step")
      .eq("id", currentTrail.id)
      .single();

    if (updatedTrail) {
      currentTrail = updatedTrail;
      renderHeader(updatedTrail);
    }
  }

  async function sendMessage(text) {
    if (!currentTrail) return;
    if (!text) return;

    sendBtn.disabled = true;
    chatStatus.textContent = "Enviando...";

    const { error } = await window.supabaseClient.functions.invoke("edulegal-cha", {
      body: { trail_id: currentTrail.id, message: text }
    });

    sendBtn.disabled = false;

    if (error) {
      chatStatus.textContent = "Erro ao enviar mensagem.";
      return;
    }

    chatStatus.textContent = "";
    inputEl.value = "";

    await refreshTrailState();
    await loadMessages();
  }

  sendBtn.addEventListener("click", () => {
    sendMessage(inputEl.value.trim());
  });

  inputEl.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      sendMessage(inputEl.value.trim());
    }
  });

  uploadBtn.addEventListener("click", async () => {
    if (!currentTrail) return;

    const file = fileInput.files[0];
    if (!file) return;

    uploadBtn.disabled = true;
    chatStatus.textContent = "Enviando print...";

    const userId = session.user.id;
    const filePath = `${userId}/${currentTrail.id}/${Date.now()}_${file.name}`;

    const { error: uploadError } = await window.supabaseClient.storage
      .from("evidence")
      .upload(filePath, file);

    if (uploadError) {
      chatStatus.textContent = "Erro no upload.";
      uploadBtn.disabled = false;
      return;
    }

    const { data } = await window.supabaseClient.storage
      .from("evidence")
      .createSignedUrl(filePath, 3600);

    const imageUrl = data.signedUrl;

    await sendMessage(`EVIDÊNCIA_PRINT (analisar imagem): ${imageUrl}`);

    fileInput.value = "";
    uploadBtn.disabled = false;
    chatStatus.textContent = "";
  });

  openTrailBtn.addEventListener("click", async () => {
    const id = trailSelect.value;
    if (!id) return;
    await openTrail(id);
  });

  await loadTrailsList();

})();

async function logout() {
  await window.supabaseClient.auth.signOut();
  window.location.href = "index.html";
}
</script>

</body>
</html>
