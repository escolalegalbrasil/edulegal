<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EduLegal - Chat</title>
<link rel="stylesheet" href="style.css">
</head>

<body>

<h1>Bem-vindo ao EduLegal ðŸš€</h1>

<div id="studentInfo"></div>

<div id="chatBox" style="margin-top:16px; padding:12px; border:1px solid #ddd; max-width:520px;">
  <h3>Chat</h3>
  <div id="messages" style="display:flex; flex-direction:column; gap:8px; margin:10px 0;"></div>

  <textarea id="chatInput" rows="3" style="width:100%; box-sizing:border-box;" placeholder="Escreva aqui..."></textarea>

  <input type="file" id="fileInput" accept="image/*" style="margin-top:8px;" />
  <button id="uploadBtn" style="margin-top:8px;">Enviar print</button>
  
  <button id="sendBtn" style="margin-top:8px;">Enviar</button>

  <p id="chatStatus" style="margin-top:8px; font-size:12px; opacity:0.8;"></p>
</div>

<button onclick="logout()">Sair</button>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
const supabaseUrl = "https://xhasvagsodoctsqbfwkw.supabase.co";
const supabaseKey = "sb_publishable_xkkU9fI3Gv9dpEf7kadVBw_9GrcLZzr";
window.supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey);
</script>

<script>
(async function init() {

  const { data: sessionData } = await window.supabaseClient.auth.getSession();
  const session = sessionData?.session;

  if (!session) {
    window.location.href = "index.html";
    return;
  }

  const { data: trails } = await window.supabaseClient
    .from("trails")
    .select("id,title,content,created_at")
    .order("created_at", { ascending: false })
    .limit(1);

  if (!trails || trails.length === 0) {
    document.getElementById("studentInfo").innerHTML = "<p>Nenhuma mentoria encontrada.</p>";
    return;
  }

  const trail = trails[0];
  const content = trail.content || {};
  const quests = Array.isArray(content.quests) ? content.quests : [];

  let html = `<h2>${trail.title || "Mentoria"}</h2>`;

  if (quests.length > 0) {
    const q1 = quests[0];
    html += `
      <h3>Quest Atual</h3>
      <p><b>Objetivo:</b> ${q1.goal || q1.micro_objective || ""}</p>
      <p><b>Pergunta:</b> ${q1.question || q1.initial_question || ""}</p>
      <p><b>Desafio:</b> ${q1.challenge || q1.mini_challenge?.instruction || ""}</p>
    `;
  }

  document.getElementById("studentInfo").innerHTML = html;

  const messagesEl = document.getElementById("messages");
  const inputEl = document.getElementById("chatInput");
  const sendBtn = document.getElementById("sendBtn");
  const uploadBtn = document.getElementById("uploadBtn");
  const fileInput = document.getElementById("fileInput");
  const statusEl = document.getElementById("chatStatus");

  function renderMessages(rows) {
  messagesEl.innerHTML = "";

  for (const m of rows) {
    const bubble = document.createElement("div");
    bubble.style.padding = "8px";
    bubble.style.borderRadius = "8px";
    bubble.style.border = m.role === "student"
      ? "1px solid #cfc"
      : "1px solid #ccf";
    bubble.style.whiteSpace = "pre-wrap";

    const content = m.content || "";

    // Procura qualquer URL dentro da mensagem
    const urlMatch = content.match(/https?:\/\/[^\s]+/);

    if (urlMatch && urlMatch[0].includes("/storage/v1/object/sign/evidence/")) {

      const img = document.createElement("img");
      img.src = urlMatch[0];
      img.style.maxWidth = "100%";
      img.style.marginTop = "6px";
      img.style.borderRadius = "6px";

      bubble.innerHTML = `<b>${m.role === "student" ? "VocÃª" : "IA"}:</b><br>${content.replace(urlMatch[0], "")}`;
      bubble.appendChild(img);

    } else {
      bubble.innerHTML = `<b>${m.role === "student" ? "VocÃª" : "IA"}:</b> ${content}`;
    }

    messagesEl.appendChild(bubble);
  }
}

  async function loadMessages() {
    const { data: rows } = await window.supabaseClient
      .from("messages")
      .select("role,content,created_at")
      .eq("trail_id", trail.id)
      .order("created_at", { ascending: true });

    renderMessages(rows || []);
  }

  async function sendMessage(text) {
    if (!text) return;

    sendBtn.disabled = true;
    statusEl.textContent = "Enviando...";

    const { error } = await window.supabaseClient.functions.invoke("edulegal-cha", {
      body: { trail_id: trail.id, message: text }
    });

    sendBtn.disabled = false;
    statusEl.textContent = "";

    if (error) {
      statusEl.textContent = "Erro ao enviar mensagem.";
      return;
    }

    inputEl.value = "";
    await loadMessages();
  }

  sendBtn.addEventListener("click", () => {
    sendMessage(inputEl.value.trim());
  });

  inputEl.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      sendMessage(inputEl.value.trim());
    }
  });

  uploadBtn.addEventListener("click", async () => {
    const file = fileInput.files[0];
    if (!file) return;

    uploadBtn.disabled = true;
    statusEl.textContent = "Enviando print...";

    const userId = session.user.id;
    const filePath = `${userId}/${trail.id}/${Date.now()}_${file.name}`;

    const { error: uploadError } = await window.supabaseClient.storage
      .from("evidence")
      .upload(filePath, file);

    if (uploadError) {
      statusEl.textContent = "Erro no upload.";
      uploadBtn.disabled = false;
      return;
    }

    const { data } = await window.supabaseClient.storage
      .from("evidence")
      .createSignedUrl(filePath, 3600);

    const imageUrl = data.signedUrl;

    await sendMessage(`Enviei um print como evidÃªncia: ${imageUrl}`);

    fileInput.value = "";
    uploadBtn.disabled = false;
  });

  await loadMessages();

})();

async function logout() {
  await window.supabaseClient.auth.signOut();
  window.location.href = "index.html";
}
</script>

</body>
</html>
