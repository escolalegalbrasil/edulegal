<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EduLegal - Chat</title>
<link rel="stylesheet" href="style.css">
</head>

<body>

<h1>Bem-vindo ao EduLegal ðŸš€</h1>

<div id="studentInfo"></div>

<div id="chatBox" style="margin-top:16px; padding:12px; border:1px solid #ddd; max-width:520px;">
  <h3>Chat</h3>
  <div id="messages" style="display:flex; flex-direction:column; gap:8px; margin:10px 0;"></div>

  <textarea id="chatInput" rows="3" style="width:100%; box-sizing:border-box;" placeholder="Escreva aqui..."></textarea>
  <button id="sendBtn" style="margin-top:8px;">Enviar</button>

  <p id="chatStatus" style="margin-top:8px; font-size:12px; opacity:0.8;"></p>
</div>

<button onclick="logout()">Sair</button>

<!-- 1ï¸âƒ£ Carrega Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<!-- 2ï¸âƒ£ Cria o cliente -->
<script>
const supabaseUrl = "https://xhasvagsodoctsqbfwkw.supabase.co";
const supabaseKey = "sb_publishable_xkkU9fI3Gv9dpEf7kadVBw_9GrcLZzr";
window.supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey);
</script>

<!-- 3ï¸âƒ£ Script principal -->
<script>
(async function init() {

  // Verifica sessÃ£o
  const { data: sessionData } = await window.supabaseClient.auth.getSession();
  const session = sessionData?.session;

  if (!session) {
    window.location.href = "index.html";
    return;
  }

  // Busca mentoria
  const { data: trails } = await window.supabaseClient
    .from("trails")
    .select("id,title,content,created_at")
    .order("created_at", { ascending: false })
    .limit(1);

  if (!trails || trails.length === 0) {
    document.getElementById("studentInfo").innerHTML = "<p>Nenhuma mentoria encontrada.</p>";
    return;
  }

  const trail = trails[0];
  const content = trail.content || {};
  const quests = Array.isArray(content.quests) ? content.quests : [];

  let html = `<h2>${trail.title || "Mentoria"}</h2>`;

  if (quests.length > 0) {
    const q1 = quests[0];
    html += `
      <h3>Quest 1</h3>
      <p><b>Objetivo:</b> ${q1.goal || q1.micro_objective || ""}</p>
      <p><b>Pergunta inicial:</b> ${q1.question || q1.initial_question || ""}</p>
      <p><b>Mini-desafio:</b> ${q1.challenge || q1.mini_challenge?.instruction || ""}</p>
    `;
  }

  document.getElementById("studentInfo").innerHTML = html;

  // ===== CHAT =====

  const messagesEl = document.getElementById("messages");
  const inputEl = document.getElementById("chatInput");
  const sendBtn = document.getElementById("sendBtn");
  const statusEl = document.getElementById("chatStatus");

  function renderMessages(rows) {
    messagesEl.innerHTML = "";
    for (const m of rows) {
      const bubble = document.createElement("div");
      bubble.style.padding = "8px 10px";
      bubble.style.borderRadius = "10px";
      bubble.style.maxWidth = "90%";
      bubble.style.whiteSpace = "pre-wrap";

      if (m.role === "student") {
        bubble.style.alignSelf = "flex-end";
        bubble.style.border = "1px solid #cfc";
      } else {
        bubble.style.alignSelf = "flex-start";
        bubble.style.border = "1px solid #ccf";
      }

      bubble.innerHTML = `<b>${m.role === "student" ? "VocÃª" : "IA"}:</b> ${m.content}`;
      messagesEl.appendChild(bubble);
    }
  }

  async function loadMessages() {
    const { data: rows } = await window.supabaseClient
      .from("messages")
      .select("role,content,created_at")
      .eq("trail_id", trail.id)
      .order("created_at", { ascending: true });

    renderMessages(rows || []);
  }

  async function sendMessage() {
    const text = inputEl.value.trim();
    if (!text) return;

    sendBtn.disabled = true;
    statusEl.textContent = "Enviando...";

    const { data, error } = await window.supabaseClient.functions.invoke("edulegal-cha", {
      body: { trail_id: trail.id, message: text }
    });

    if (error) {
      statusEl.textContent = "Erro ao enviar mensagem.";
      sendBtn.disabled = false;
      return;
    }

    inputEl.value = "";
    statusEl.textContent = "";
    sendBtn.disabled = false;

    await loadMessages();
  }

  sendBtn.addEventListener("click", sendMessage);

  inputEl.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });

  await loadMessages();

})();

async function logout() {
  await window.supabaseClient.auth.signOut();
  window.location.href = "index.html";
}
</script>

</body>
</html>
